{% extends 'base.html' %}
{% load group_tags %}
{% load i18n %}

{% block content %}
<div class="mb-2 text-center">
  <h2 class="fw-bold text-success">{% trans "Статистика" %}</h2>
  <p class="text-muted">{% trans "Просматривайте результаты тестов и анализируйте успеваемость." %}</p>
</div>

{% if user.role == "teacher" %}
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <form method="get" class="row g-2 align-items-center justify-content-between">

        <!-- Левая часть: фильтр -->
        <div class="col-md-5 d-flex align-items-center">
          <select name="test" class="form-select me-2">
            <option value="">{% trans "Все тесты" %}</option>
            {% for t in tests %}
              <option value="{{ t.id }}" {% if selected_test_id == t.id %}selected{% endif %}>
                {{ t.title }}
              </option>
            {% endfor %}
          </select>
          <button type="submit" class="btn btn-success">
            <i class="fas fa-filter me-1"></i> {% trans "Фильтровать" %}
          </button>
        </div>

        <!-- Правая часть: экспорт -->
        <div class="col-md-5 d-flex justify-content-end align-items-center">
          <select name="format" class="form-select me-2" style="max-width: 180px;">
            <option value="excel">Excel (.xlsx)</option>
            <option value="pdf">PDF</option>
          </select>
          <button type="submit" formaction="{% url 'export_statistics' %}" class="btn btn-outline-success">
            <i class="fas fa-download me-1"></i> {% trans "Скачать" %}
          </button>
        </div>

      </form>

      {% if summary %}
        <div class="alert alert-success mt-3 mb-0">
          <strong>{% trans "Средний балл:" %}</strong> {{ summary.avg_score }} |
          <strong>{% trans "Количество попыток:" %}</strong> {{ summary.attempts }}
        </div>
      {% elif selected_test_id %}
        <div class="alert alert-warning mt-3 mb-0">
          {% trans "По выбранному тесту пока нет результатов." %}
        </div>
      {% endif %}
    </div>
  </div>
{% endif %}

<div class="card card-unified shadow-sm">
  <div class="card-body p-0">
    <table class="table table-green mb-0 align-middle">
      <thead class="table-success">
        <tr>
          <th>{% trans "Дата" %}</th>
          <th>{% trans "Тест" %}</th>
          {% if user.role == "teacher" %}
            <th>{% trans "Сдал" %}</th>
          {% endif %}
          <th>{% trans "Попытка" %}</th>
          <th>{% trans "Баллы" %}</th>
          <th>%</th>
          <th>{% trans "Пройден" %}</th>
        </tr>
      </thead>
      <tbody>
        {% for r in results %}
          <tr>
            <td>{{ r.date_taken|date:"d.m.Y H:i" }}</td>
            <td class="fw-semibold text-success">{{ r.test.title }}</td>
            {% if user.role == "teacher" %}
              <td>{{ r.user.username }}</td>
            {% endif %}
            <td>{{ r.attempt }}</td>
            <td>{{ r.score }}/{{ r.total }}</td>
            <td>{{ r.percentage }}</td>
            <td>
              {% if r.passed %}
                <span class="badge bg-success">{% trans "Да" %}</span>
              {% else %}
                <span class="badge bg-danger">{% trans "Нет" %}</span>
              {% endif %}
            </td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="{% if user.role == 'teacher' %}7{% else %}6{% endif %}" class="text-center text-muted">
              {% trans "Нет данных" %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{% endblock %}
