{% extends 'base.html' %}
{% load group_tags %}   {# не забудь загрузить свои теги #}
{% block content %}
<h1 class="mb-4">Статистика</h1>

{% if user|has_group:"Учителя" %}
  <form method="get" class="row g-2 mb-3">
    <div class="col-auto">
      <select name="test" class="form-select">
        <option value="">Все тесты</option>
        {% for t in tests %}
          <option value="{{ t.id }}" {% if selected_test_id == t.id %}selected{% endif %}>{{ t.title }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-auto">
      <button class="btn btn-success">Фильтровать</button>
    </div>
  </form>

  {% if summary %}
    <div class="alert alert-success mb-3">
      Средний балл: {{ summary.avg_score }} | Кол-во попыток: {{ summary.attempts }}
    </div>
  {% endif %}

  <table class="table table-striped align-middle">
    <thead>
      <tr>
        <th>Дата</th>
        <th>Тест</th>
        <th>Сдал</th>
        <th>Попытка</th>
        <th>Баллы</th>
        <th>%</th>
        <th>Пройден</th>
      </tr>
    </thead>
    <tbody>
      {% for r in results %}
      <tr>
        <td>{{ r.date_taken|date:"d.m.Y H:i" }}</td>
        <td>{{ r.test.title }}</td>
        <td>{{ r.user.username }}</td>
        <td>{{ r.attempt }}</td>
        <td>{{ r.score }}/{{ r.total }}</td>
        <td>{{ r.percentage }}</td>
        <td>{% if r.passed %}Да{% else %}Нет{% endif %}</td>
      </tr>
      {% empty %}
      <tr><td colspan="7">Нет данных</td></tr>
      {% endfor %}
    </tbody>
  </table>

{% else %}
  <table class="table table-striped align-middle">
    <thead>
      <tr>
        <th>Дата</th>
        <th>Тест</th>
        <th>Попытка</th>
        <th>Баллы</th>
        <th>%</th>
        <th>Пройден</th>
      </tr>
    </thead>
    <tbody>
      {% for r in results %}
      <tr>
        <td>{{ r.date_taken|date:"d.m.Y H:i" }}</td>
        <td>{{ r.test.title }}</td>
        <td>{{ r.attempt }}</td>
        <td>{{ r.score }}/{{ r.total }}</td>
        <td>{{ r.percentage }}</td>
        <td>{% if r.passed %}Да{% else %}Нет{% endif %}</td>
      </tr>
      {% empty %}
      <tr><td colspan="6">Пока нет результатов</td></tr>
      {% endfor %}
    </tbody>
  </table>
{% endif %}
{% endblock %}
